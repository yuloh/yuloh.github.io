<!DOCTYPE html>
<html lang="en-us">
	<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Matt Allan">

<meta name="generator" content="Hugo 0.34" />
<title>Understanding Dependency Injection Containers</title>
<link rel="shortcut icon" href="http://mattallan.org/images/favicon.ico">
<link rel="stylesheet" href="http://mattallan.org/css/style.css">
<link rel="stylesheet" href="http://mattallan.org/css/highlight.css">

<link rel="stylesheet" href="http://mattallan.org/css/custom.css">

<link rel="stylesheet" href="http://mattallan.org/css/syntax.css">



<link rel="stylesheet" href="http://mattallan.org/css/monosocialiconsfont.css">



<link href="http://mattallan.org/index.xml" rel="alternate" type="application/rss+xml" title="Matt Allan" />


<meta property="og:title" content="Understanding Dependency Injection Containers" />
<meta property="og:description" content="Introduction If you are writing modern PHP, you will run across dependency injection a lot. Basically all dependency injection means is that if an object needs something, you pass it in. So if you have a class like this:
&lt;?php class UsersController { public function index() { $repository = new UserRepository( new DbAdapter( &#39;mysql:dbname=testdb;host=127.0.0.1&#39;, &#39;dbuser&#39;, &#39;dbpass&#39; ) ); $users = $repository-&gt;all(); return json_encode($users); } }&lt;?php $controller = new UsersController(); &hellip;you would pass in (inject) the object it needs (the dependency) instead of instantiating it in the class." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://mattallan.org/posts/dependency-injection-containers/" />



<meta property="article:published_time" content="2016-07-15T12:00:00-05:00"/>

<meta property="article:modified_time" content="2016-07-15T12:00:00-05:00"/>













<meta itemprop="name" content="Understanding Dependency Injection Containers">
<meta itemprop="description" content="Introduction If you are writing modern PHP, you will run across dependency injection a lot. Basically all dependency injection means is that if an object needs something, you pass it in. So if you have a class like this:
&lt;?php class UsersController { public function index() { $repository = new UserRepository( new DbAdapter( &#39;mysql:dbname=testdb;host=127.0.0.1&#39;, &#39;dbuser&#39;, &#39;dbpass&#39; ) ); $users = $repository-&gt;all(); return json_encode($users); } }&lt;?php $controller = new UsersController(); &hellip;you would pass in (inject) the object it needs (the dependency) instead of instantiating it in the class.">


<meta itemprop="datePublished" content="2016-07-15T12:00:00-05:00" />
<meta itemprop="dateModified" content="2016-07-15T12:00:00-05:00" />
<meta itemprop="wordCount" content="1024">



<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Understanding Dependency Injection Containers"/>
<meta name="twitter:description" content="Introduction If you are writing modern PHP, you will run across dependency injection a lot. Basically all dependency injection means is that if an object needs something, you pass it in. So if you have a class like this:
&lt;?php class UsersController { public function index() { $repository = new UserRepository( new DbAdapter( &#39;mysql:dbname=testdb;host=127.0.0.1&#39;, &#39;dbuser&#39;, &#39;dbpass&#39; ) ); $users = $repository-&gt;all(); return json_encode($users); } }&lt;?php $controller = new UsersController(); &hellip;you would pass in (inject) the object it needs (the dependency) instead of instantiating it in the class."/>
<meta name="twitter:site" content="@https://www.twitter.com/__yuloh"/>


    </head>
<body>
    <nav class="main-nav">
	
		<a href='http://mattallan.org/'> <span class="arrow">←</span>Home</a>
	

	

	
		<a class="cta" href="http://mattallan.org/index.xml">Subscribe</a>
	
</nav>

    <section id="wrapper">
        
        
<article class="post">
    <header>
        <h1>Understanding Dependency Injection Containers</h1>
        <h2 class="subtitle"></h2>
        <h2 class="headline">
        July 15, 2016
        <br>
        
        </h2>
    </header>
    <section id="post-body">
        

<h1 id="introduction">Introduction</h1>

<p>If you are writing modern PHP, you will run across dependency injection a lot. Basically all dependency injection means is that if an object needs something, you pass it in.  So if you have a class like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">UsersController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="o"></span><span class="nf">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$repository</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserRepository</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">DbAdapter</span><span class="p">(</span>
                <span class="s1">&#39;mysql:dbname=testdb;host=127.0.0.1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dbuser&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dbpass&#39;</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$users</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">json_encode</span><span class="p">(</span><span class="nv">$users</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UsersController</span><span class="p">();</span></code></pre></div>
<p>&hellip;you would pass in (inject) the object it needs (the dependency) instead of instantiating it in the class.</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">UsersController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="o"></span><span class="fm">__construct</span><span class="p">(</span><span class="nx">UserRepository</span> <span class="nv">$userRepository</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userRepository</span> <span class="o">=</span> <span class="nv">$userRepository</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="o"></span><span class="nf">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$users</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userRepository</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">json_encode</span><span class="p">(</span><span class="nv">$users</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$dbAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DbAdapter</span><span class="p">(</span>
    <span class="s1">&#39;mysql:dbname=testdb;host=127.0.0.1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dbuser&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dbpass&#39;</span>
<span class="p">);</span>
<span class="nv">$userRepository</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserRepository</span><span class="p">(</span><span class="nv">$dbAdapter</span><span class="p">);</span>
<span class="nv">$usersController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UsersController</span><span class="p">(</span><span class="nv">$userRepository</span><span class="p">);</span></code></pre></div>
<p>Dependency injection makes your code more flexible and easier to test.  If you want to learn more about dependency injection in general, check out <a href="http://www.phptherightway.com/#dependency_injection">this summary in the PHP The Right Way guide</a>.</p>

<h1 id="containers">Containers</h1>

<p>Once you are doing this all over the place, you end up writing a lot of boilerplate code to create each object.  Now when we create the controller we need to create it&rsquo;s dependency (the user repository), and that dependencies dependency (the db adapter) etc.  It&rsquo;s a pain.  To make that easier we use containers.</p>

<p>You can tell the container how to make your object, and use the container each time you need it.  That way you only have to write the code once.</p>

<p>Since we need to be able to get our objects back out of the container, we need to name them.  You can use a short name like &lsquo;db&rsquo;, but I like to use the class name.</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nx">DbAdapter</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">DbAdapter</span><span class="p">(</span>
        <span class="s1">&#39;mysql:dbname=testdb;host=127.0.0.1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dbuser&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dbpass&#39;</span>
    <span class="p">);</span>
<span class="p">});</span></code></pre></div>
<h2 id="writing-a-simple-container">Writing a Simple Container</h2>

<h3 id="setting-entries">Setting Entries</h3>

<p>To understand how this works, lets write a simple container.  The first thing we need is a <code>set</code> method.  The <code>set</code> method will accept a string name for the entry and an <a href="http://php.net/manual/en/functions.anonymous.php">anonymous function</a> for the definition.  We are type hinting the <a href="http://php.net/manual/en/class.closure.php">Closure</a> class to make sure they actually give us an anonymous function.</p>

<p>When we set an entry we add it to an array, indexed by name.</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">Container</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$entries</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="sd">/**
</span><span class="sd">     * Adds an entry to the container.
</span><span class="sd">     *
</span><span class="sd">     * @param string   $id       Identifier of the entry.
</span><span class="sd">     * @param \Closure $value    The closure to invoke when this entry is resolved.
</span><span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="o"></span><span class="nf">set</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nx">\Closure</span> <span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entries</span><span class="p">[</span><span class="nv">$id</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h3 id="getting-entries">Getting Entries</h3>

<p>Now we need to be able to get an entry back.  To get something out of the container, we just need to check our array of entries for the id.  If it&rsquo;s there we need to invoke the closure and return it&rsquo;s value.</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>


<span class="k">class</span> <span class="nc">NotFoundException</span> <span class="k">extends</span> <span class="nx">\RuntimeException</span> <span class="p">{}</span>

<span class="k">class</span> <span class="nc">Container</span>
<span class="p">{</span>
    <span class="c1">// existing code...
</span><span class="c1"></span>
    <span class="sd">/**
</span><span class="sd">     * Finds an entry of the container by its identifier and returns it.
</span><span class="sd">     *
</span><span class="sd">     * @param string $id Identifier of the entry to look for.
</span><span class="sd">     *
</span><span class="sd">     * @throws NotFoundException  No entry was found for this identifier.
</span><span class="sd">     *
</span><span class="sd">     * @return mixed The resolved value for the entry.
</span><span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="o"></span><span class="nf">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">array_key_exists</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entries</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">NotFoundException</span><span class="p">(</span><span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;The entry for %s was not found.&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entries</span><span class="p">[</span><span class="nv">$id</span><span class="p">]();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>It should be clear why containers use closures now.  The code inside of the closure isn&rsquo;t actually ran until you try to resolve the entry, so you aren&rsquo;t creating the objects until you need them.</p>

<h3 id="getting-entries-that-need-other-entries">Getting Entries That Need Other Entries</h3>

<p>Now we have a simple container that works.  We can add entries and resolve them.  But what about entries that depend on other entries?  All you need to do is pass in the container as the first argument to the closure.</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">Container</span>
<span class="p">{</span>
    <span class="c1">// existing code...
</span><span class="c1"></span>
    <span class="sd">/**
</span><span class="sd">     * Finds an entry of the container by its identifier and returns it.
</span><span class="sd">     *
</span><span class="sd">     * @param string $id Identifier of the entry to look for.
</span><span class="sd">     *
</span><span class="sd">     * @throws NotFoundException  No entry was found for this identifier.
</span><span class="sd">     *
</span><span class="sd">     * @return mixed The resolved value for the entry.
</span><span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="o"></span><span class="nf">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">array_key_exists</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entries</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">NotFoundException</span><span class="p">(</span><span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;The entry for %s was not found.&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="c1">// Pass in the container as the only argument to the closure when we invoke it.
</span><span class="c1"></span>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entries</span><span class="p">[</span><span class="nv">$id</span><span class="p">](</span><span class="nv">$this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>Now when we set our entry, we can use the container instance that gets passed in to resolve our entry&rsquo;s dependencies.</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nx">DbAdapter</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">DbAdapter</span><span class="p">(</span><span class="s1">&#39;mysql:dbname=testdb;host=127.0.0.1&#39;</span><span class="p">,</span> <span class="s1">&#39;dbuser&#39;</span><span class="p">,</span> <span class="s1">&#39;dbpass&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nx">UserRepository</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Container</span> <span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$dbAdapter</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">DbAdapter</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">UserRepository</span><span class="p">(</span><span class="nv">$dbAdapter</span><span class="p">);</span>
<span class="p">});</span></code></pre></div>
<p>Since the closure isn&rsquo;t invoked until you try to resolve something, you can register your entries in whatever order you like and it will work.</p>

<h3 id="binding-singletons">Binding Singletons</h3>

<p>Right now <code>$container-&gt;get()</code> will invoke the closure each time it&rsquo;s called and create a brand new object.  Sometimes you want to bind a <a href="https://en.wikipedia.org/wiki/Singleton_pattern">singleton</a> entry, where each call to <code>get</code> returns the same instance.</p>

<p>For example, you usually want a singleton for the database adapter, since it&rsquo;s going to try and create a new connection each time you make one.  Make sense?</p>

<p>Lets add a <code>share</code> method which returns the same entry each time.  To make a shared instance, we wrap the original closure in our own closure. The first time our closure is invoked we will invoke the original closure and save it&rsquo;s return value to a static variable.  Each time it&rsquo;s invoked after that we just return the resolved value.</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">Container</span>
<span class="p">{</span>
    <span class="c1">// existing code...
</span><span class="c1"></span>
    <span class="sd">/**
</span><span class="sd">     * Adds a shared (singleton) entry to the container.
</span><span class="sd">     *
</span><span class="sd">     * @param string   $id       Identifier of the entry.
</span><span class="sd">     * @param \Closure $value    The closure to invoke when this entry is resolved.
</span><span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="o"></span><span class="nf">share</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nx">\Closure</span> <span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entries</span><span class="p">[</span><span class="nv">$id</span><span class="p">]</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$container</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">static</span> <span class="nv">$resolvedValue</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">is_null</span><span class="p">(</span><span class="nv">$resolvedValue</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$resolvedValue</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">(</span><span class="nv">$container</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nv">$resolvedValue</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h3 id="wrapping-up">Wrapping Up</h3>

<p>Awesome!  Now you have a container that has enough features to be useful.  If you would like to see an example of what everything looks like together, checkout <a href="https://github.com/yuloh/container/blob/master/src/Container.php">the source code of yuloh/container</a>, a simple container built just like this.</p>

    </section>
</article>

<footer id="post-meta" class="clearfix">
    <a href="https://twitter.com/__yuloh">
    <img class="avatar" src="http://mattallan.org/images/avatar.png">
    <div>
        <span class="dark">Matt Allan</span>
        <span></span>
    </div>
    </a>
    <section id="sharing">
        <a class="twitter" href="https://twitter.com/intent/tweet?text=http%3a%2f%2fmattallan.org%2fposts%2fdependency-injection-containers%2f - Understanding%20Dependency%20Injection%20Containers by @__yuloh"><span class="icon-twitter"> tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

    </section>
</footer>



<ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="/posts/protobuf-php-services/">Protobuf PHP Services<aside class="dates">Jan 27 2018</aside></a>
        </li>
    
        <li>
            <a href="/posts/dependency-injection-containers-part-ii-autowiring/">Understanding Dependency Injection Containers Part II - Autowiring<aside class="dates">Sep 1 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/setting-the-guard-per-route-in-laravel/">Setting the Guard Per Route in Laravel<aside class="dates">Jul 22 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/json-schema-references/">JSON Schema References<aside class="dates">May 5 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/dont-use-illuminate-support/">Don&#39;t Use Illuminate Support<aside class="dates">Apr 21 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/github-pages-best-practices/">Github Pages Best Practices<aside class="dates">Apr 12 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/iife-life-iife-in-php/">IIFE LIFE - IIFE In PHP<aside class="dates">Apr 12 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/automatically-run-unit-tests-with-entr/">Automatically Run Unit Tests With entr<aside class="dates">Mar 31 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/rest-and-ddd/">REST and DDD<aside class="dates">Mar 30 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/why-you-should-be-using-annotations/">Why you should be using annotations (with Doctrine)<aside class="dates">Feb 19 2016</aside></a>
        </li>
    
</ul>



        <footer id="footer">
    
        <div id="social">

	
	
    
    <a class="symbol" href="https://www.github.com/yuloh">
        circlegithub
    </a>
    
    <a class="symbol" href="https://www.twitter.com/__yuloh">
        circletwitterbird
    </a>
    


</div>

    
    <p class="small">
    
        © Copyright 2018 Matt Allan
    
    </p>
</footer>

    </section>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://mattallan.org/js/main.js"></script>
<script src="http://mattallan.org/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>





</body>
</html>
