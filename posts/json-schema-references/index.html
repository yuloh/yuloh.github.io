<!DOCTYPE html>
<html lang="en-us">
	<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Matt Allan">

<meta name="generator" content="Hugo 0.34" />
<title>JSON Schema References</title>
<link rel="shortcut icon" href="http://mattallan.org/images/favicon.ico">
<link rel="stylesheet" href="http://mattallan.org/css/style.css">
<link rel="stylesheet" href="http://mattallan.org/css/highlight.css">

<link rel="stylesheet" href="http://mattallan.org/css/custom.css">

<link rel="stylesheet" href="http://mattallan.org/css/syntax.css">



<link rel="stylesheet" href="http://mattallan.org/css/monosocialiconsfont.css">



<link href="http://mattallan.org/index.xml" rel="alternate" type="application/rss+xml" title="Matt Allan" />


<meta property="og:title" content="JSON Schema References" />
<meta property="og:description" content="Introduction I recently wrote a validator for JSON Schema. One of the hardest parts to figure out was how to resolve references, so I figured I would write a quick post explaining what I learned.
References A JSON reference is a way to reference another part of the document, or another schema. There is actually a IETF draft for it, so it isn&rsquo;t specific to JSON Schema.
A simple example would look like this:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://mattallan.org/posts/json-schema-references/" />



<meta property="article:published_time" content="2016-05-05T12:00:00-05:00"/>

<meta property="article:modified_time" content="2016-05-05T12:00:00-05:00"/>













<meta itemprop="name" content="JSON Schema References">
<meta itemprop="description" content="Introduction I recently wrote a validator for JSON Schema. One of the hardest parts to figure out was how to resolve references, so I figured I would write a quick post explaining what I learned.
References A JSON reference is a way to reference another part of the document, or another schema. There is actually a IETF draft for it, so it isn&rsquo;t specific to JSON Schema.
A simple example would look like this:">


<meta itemprop="datePublished" content="2016-05-05T12:00:00-05:00" />
<meta itemprop="dateModified" content="2016-05-05T12:00:00-05:00" />
<meta itemprop="wordCount" content="496">



<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="JSON Schema References"/>
<meta name="twitter:description" content="Introduction I recently wrote a validator for JSON Schema. One of the hardest parts to figure out was how to resolve references, so I figured I would write a quick post explaining what I learned.
References A JSON reference is a way to reference another part of the document, or another schema. There is actually a IETF draft for it, so it isn&rsquo;t specific to JSON Schema.
A simple example would look like this:"/>
<meta name="twitter:site" content="@https://www.twitter.com/__yuloh"/>


    </head>
<body>
    <nav class="main-nav">
	
		<a href='http://mattallan.org/'> <span class="arrow">‚Üê</span>Home</a>
	

	

	
		<a class="cta" href="http://mattallan.org/index.xml">Subscribe</a>
	
</nav>

    <section id="wrapper">
        
        
<article class="post">
    <header>
        <h1>JSON Schema References</h1>
        <h2 class="subtitle"></h2>
        <h2 class="headline">
        May 5, 2016
        <br>
        
        </h2>
    </header>
    <section id="post-body">
        

<h2 id="introduction">Introduction</h2>

<p>I recently <a href="http://json-guard.thephpleague.com/">wrote a validator</a> for JSON Schema.  One of the hardest parts to figure out was how to resolve references, so I figured  I would write a quick post explaining what I learned.</p>

<h2 id="references">References</h2>

<p>A JSON reference is a way to reference another part of the document, or another schema.  There is actually a <a href="https://tools.ietf.org/html/draft-pbryan-zyp-json-ref-03">IETF draft</a> for it, so it isn&rsquo;t specific to JSON Schema.</p>

<p>A simple example would look like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;$schema&#34;</span><span class="p">:</span> <span class="s2">&#34;http://json-schema.org/draft-04/schema#&#34;</span><span class="p">,</span>
  <span class="nt">&#34;definitions&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;pet&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
      <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span>  <span class="p">{</span> <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">},</span>
        <span class="nt">&#34;breed&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">},</span>
        <span class="nt">&#34;age&#34;</span><span class="p">:</span>  <span class="p">{</span> <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;breed&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
  <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;cat&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&#34;$ref&#34;</span><span class="p">:</span> <span class="s2">&#34;#/definitions/pet&#34;</span> <span class="p">},</span>
    <span class="nt">&#34;dog&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&#34;$ref&#34;</span><span class="p">:</span> <span class="s2">&#34;#/definitions/pet&#34;</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>The reference is a <a href="https://tools.ietf.org/html/rfc6901">JSON pointer</a> to another part of the document.  To validate the schema the reference needs to be resolved.  The naive way to do this is to inline the reference, so that the document looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;$schema&#34;</span><span class="p">:</span> <span class="s2">&#34;http://json-schema.org/draft-04/schema#&#34;</span><span class="p">,</span>
  <span class="nt">&#34;definitions&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="err">//</span> <span class="err">The</span> <span class="err">definition</span> <span class="err">is</span> <span class="err">probably</span> <span class="err">still</span> <span class="err">here,</span> <span class="err">but</span> <span class="err">not</span> <span class="err">actually</span> <span class="err">used</span> <span class="err">anymore.</span>
  <span class="p">},</span>
  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
  <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;cat&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
      <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span>  <span class="p">{</span> <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">},</span>
        <span class="nt">&#34;breed&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">},</span>
        <span class="nt">&#34;age&#34;</span><span class="p">:</span>  <span class="p">{</span> <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;breed&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&#34;dog&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
      <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span>  <span class="p">{</span> <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">},</span>
        <span class="nt">&#34;breed&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">},</span>
        <span class="nt">&#34;age&#34;</span><span class="p">:</span>  <span class="p">{</span> <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;breed&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>That works, but it breaks down because JSON Schema allows circular references.  A circular reference looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;person&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span>
        <span class="p">},</span>
        <span class="nt">&#34;spouse&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;$ref&#34;</span><span class="p">:</span> <span class="s2">&#34;#/person&#34;</span>        <span class="err">//</span> <span class="err">circular</span> <span class="err">reference</span>
          <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>If you try to inline that reference, you are going to end up with infinite recursion.</p>

<p><img src="/images/posts/json-schema-references/Droste.jpg" alt="Droste" /></p>

<h2 id="inlining">Inlining</h2>

<p>The library I was using solved this by keeping track of how many levels of recursion took place, and throwing an exception if you exceeded them (they have since fixed this in v2.0.0).  In practice this meant that you had to re-adjust the depth depending on how nested your schema was.  It would also silently pass validation for any schemas with root pointer references, which is a pointer that starts with <code>#</code>.  This meant that you couldn&rsquo;t validate using the JSON Meta Schema, so it was impossible to verify your schema was correct.</p>

<h2 id="lazy-resolving">Lazy Resolving</h2>

<p>The solution is to not inline the schema, but to replace circular references with a proxy object that is only resolved when accessed.  <a href="https://3v4l.org/MA7ND">Here is a link to the gist I wrote when I was figuring it out</a>.  The proxy object is only resolved as long as there is data to validate.  You can still use a max depth to prevent deeply nested payloads from killing your server.</p>

<p>If you do that, your data won&rsquo;t re-encode as JSON since it has circular references.  Instead you can put the <code>$ref</code> object back and everything looks like it did before you dereferenced it.</p>

    </section>
</article>

<footer id="post-meta" class="clearfix">
    <a href="https://twitter.com/__yuloh">
    <img class="avatar" src="http://mattallan.org/images/avatar.png">
    <div>
        <span class="dark">Matt Allan</span>
        <span></span>
    </div>
    </a>
    <section id="sharing">
        <a class="twitter" href="https://twitter.com/intent/tweet?text=http%3a%2f%2fmattallan.org%2fposts%2fjson-schema-references%2f - JSON%20Schema%20References by @__yuloh"><span class="icon-twitter"> tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

    </section>
</footer>



<ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="/posts/rfc3339-date-time-validation/">RFC3339 Date-Time Validation<aside class="dates">Jan 29 2018</aside></a>
        </li>
    
        <li>
            <a href="/posts/moving-to-hugo/">[meta] Moving From Jekyll to Hugo<aside class="dates">Jan 27 2018</aside></a>
        </li>
    
        <li>
            <a href="/posts/protobuf-php-services/">Writing Protobuf Services in PHP<aside class="dates">Jan 27 2018</aside></a>
        </li>
    
        <li>
            <a href="/posts/dependency-injection-containers-part-ii-autowiring/">Understanding Dependency Injection Containers Part II - Autowiring<aside class="dates">Sep 1 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/setting-the-guard-per-route-in-laravel/">Setting the Guard Per Route in Laravel<aside class="dates">Jul 22 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/dependency-injection-containers/">Understanding Dependency Injection Containers<aside class="dates">Jul 15 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/dont-use-illuminate-support/">Don&#39;t Use Illuminate Support<aside class="dates">Apr 21 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/github-pages-best-practices/">Github Pages Best Practices<aside class="dates">Apr 12 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/iife-life-iife-in-php/">IIFE LIFE - IIFE In PHP<aside class="dates">Apr 12 2016</aside></a>
        </li>
    
        <li>
            <a href="/posts/automatically-run-unit-tests-with-entr/">Automatically Run Unit Tests With entr<aside class="dates">Mar 31 2016</aside></a>
        </li>
    
</ul>



        <footer id="footer">
    
        <div id="social">

	
	
    
    <a class="symbol" href="https://www.github.com/yuloh">
        circlegithub
    </a>
    
    <a class="symbol" href="https://www.twitter.com/__yuloh">
        circletwitterbird
    </a>
    


</div>

    
    <p class="small">
    
        ¬© Copyright 2018 Matt Allan
    
    </p>
</footer>

    </section>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://mattallan.org/js/main.js"></script>
<script src="http://mattallan.org/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>





</body>
</html>
